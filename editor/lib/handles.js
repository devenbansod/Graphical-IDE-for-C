function Handle(b){this.type=b;this.x=0;this.y=0;this.visible=true}Handle.types=["n","ne","e","se","s","sw","w","nw","r"];Handle.connectorTypes=["ns","ew"];Handle.load=function(c){var d=new Handle(c.type);d.x=c.x;d.y=c.y;d.visible=c.visible;return d};Handle.loadArray=function(e){var f=[];for(var d=0;d<e.length;d++){f.push(Handle.load(e[d]))}return f};Handle.RADIUS=3;Handle.prototype={constructor:Handle,equals:function(b){if(!b instanceof Handle){return false}return this.type==b.type&&this.x==b.x&&this.y==b.y&&this.visible==b.visible},actionFigure:function(l,j,k){var g=this.actionShape(l,j,k);if(g[0]=="rotate"){var i=new FigureRotateCommand(HandleManager.shape.id,g[1],g[2]);i.execute();History.addUndo(i)}else{if(g[0]=="scale"){var h=new FigureScaleCommand(HandleManager.shape.id,g[1],g[2]);h.execute();History.addUndo(h)}}},actionContainer:function(j,h,i){var f=this.actionShape(j,h,i);if(f[0]=="rotate"){throw"Handles.js -> actionContainer -> rotate should be disabled for Container"}else{if(f[0]=="scale"){var g=new ContainerScaleCommand(HandleManager.shape.id,f[1],f[2]);g.execute();History.addUndo(g)}}},actionGroup:function(l,j,k){var g=this.actionShape(l,j,k);if(g[0]=="rotate"){var i=new GroupRotateCommand(HandleManager.shape.id,g[1],g[2]);i.execute();History.addUndo(i)}else{if(g[0]=="scale"){var h=new GroupScaleCommand(HandleManager.shape.id,g[1],g[2]);h.execute();History.addUndo(h)}}},actionShape:function(U,C,G){var M=[];var X=HandleManager.shape.getBounds();var V=0;var W=0;var B=1;var D=1;var R=false;if(this.type=="r"){var p=HandleManager.shape.rotationCoords[0].clone();var N=Util.getAngle(HandleManager.shape.rotationCoords[0],new Point(C,G));var I=Util.getAngle(HandleManager.shape.rotationCoords[0],HandleManager.shape.rotationCoords[1]);var Y=N-I;var S=Matrix.mergeTransformations(Matrix.translationMatrix(-p.x,-p.y),Matrix.rotationMatrix(Y),Matrix.translationMatrix(p.x,p.y));var F=Matrix.mergeTransformations(Matrix.translationMatrix(-p.x,-p.y),Matrix.rotationMatrix(-Y),Matrix.translationMatrix(p.x,p.y));M=["rotate",S,F]}else{var H=Util.getAngle(HandleManager.shape.rotationCoords[0],HandleManager.shape.rotationCoords[1]);var J=HandleManager.shape.rotationCoords[0].clone();var O=new Point(C,G);O.transform(Matrix.translationMatrix(-J.x,-J.y));O.transform(Matrix.rotationMatrix(-H));O.transform(Matrix.translationMatrix(J.x,J.y));C=O.x;G=O.y;var Z=new Point(this.x,this.y);Z.transform(Matrix.translationMatrix(-J.x,-J.y));Z.transform(Matrix.rotationMatrix(-H));Z.transform(Matrix.translationMatrix(J.x,J.y));switch(this.type){case"n":W=X[3];if(G<X[3]-5){D=(X[3]-G)/(X[3]-Z.y)}break;case"s":W=X[1];if(G>X[1]+5){D=(G-X[1])/(Z.y-X[1])}break;case"w":V=X[2];if(C<X[2]-5){B=(X[2]-C)/(X[2]-Z.x)}break;case"e":V=X[0];if(C>X[0]+5){B=(C-X[0])/(Z.x-X[0])}break;case"nw":V=X[2];W=X[3];if(C<X[2]-5&&G<X[3]-5){D=(X[3]-G)/(X[3]-Z.y);B=(X[2]-C)/(X[2]-Z.x)}break;case"ne":V=X[0];W=X[3];if(C>X[0]+5&&G<X[3]-5){B=(C-X[0])/(Z.x-X[0]);D=(X[3]-G)/(X[3]-Z.y)}break;case"sw":V=X[2];W=X[1];if(C<X[2]-5&&G>X[1]+5){B=(X[2]-C)/((X[2]-Z.x));D=(G-X[1])/(Z.y-X[1])}break;case"se":V=X[0];W=X[1];if(C>X[0]+5&&G>X[1]+5){D=(G-X[1])/(Z.y-X[1]);B=(C-X[0])/(Z.x-X[0])}break}if(!SHIFT_PRESSED&&V!=0&&W!=0){if(this.getCursor()=="w-resize"||this.getCursor()=="e-resize"){D=B}else{B=D}}var P=Matrix.mergeTransformations(Matrix.translationMatrix(-J.x,-J.y),Matrix.rotationMatrix(-H),Matrix.translationMatrix(J.x,J.y));var T=Matrix.mergeTransformations(Matrix.translationMatrix(-V,-W),Matrix.scaleMatrix(B,D),Matrix.translationMatrix(V,W));var E=Matrix.mergeTransformations(Matrix.translationMatrix(-V,-W),Matrix.scaleMatrix(1/B,1/D),Matrix.translationMatrix(V,W));var K=Matrix.mergeTransformations(Matrix.translationMatrix(-J.x,-J.y),Matrix.rotationMatrix(H),Matrix.translationMatrix(J.x,J.y));var L=Matrix.mergeTransformations(P,T,K);var Q=Matrix.mergeTransformations(P,E,K);M=["scale",L,Q]}return M},actionConnector:function(g,h,i){switch(this.type){case"v":var f;for(var j=1;j<HandleManager.shape.turningPoints.length-1;j++){if(HandleManager.shape.turningPoints[j-1].y==HandleManager.shape.turningPoints[j].y&&HandleManager.shape.turningPoints[j].y==this.y&&Math.min(HandleManager.shape.turningPoints[j].x,HandleManager.shape.turningPoints[j-1].x)<=this.x&&Math.max(HandleManager.shape.turningPoints[j].x,HandleManager.shape.turningPoints[j-1].x)>=this.x){f=j}}HandleManager.shape.turningPoints[f-1].transform(Matrix.translationMatrix(0,i-g[1]));HandleManager.shape.turningPoints[f].transform(Matrix.translationMatrix(0,i-g[1]));break;case"h":var f;for(var j=1;j<HandleManager.shape.turningPoints.length-1;j++){if(HandleManager.shape.turningPoints[j-1].x==HandleManager.shape.turningPoints[j].x&&HandleManager.shape.turningPoints[j].x==this.x&&Math.min(HandleManager.shape.turningPoints[j].y,HandleManager.shape.turningPoints[j-1].y)<=this.y&&Math.max(HandleManager.shape.turningPoints[j].y,HandleManager.shape.turningPoints[j-1].y)>=this.y){f=j}}HandleManager.shape.turningPoints[f-1].transform(Matrix.translationMatrix(h-g[0],0));HandleManager.shape.turningPoints[f].transform(Matrix.translationMatrix(h-g[0],0));break}HandleManager.shape.updateMiddleText()},action:function(e,f,d){if(e==null||e.length!=2){throw"Handle:action() Last move is wrong"}if(HandleManager.shape instanceof Connector){this.actionConnector(e,f,d)}else{if(HandleManager.shape instanceof Figure){this.actionFigure(e,f,d)}else{if(HandleManager.shape instanceof Group){this.actionGroup(e,f,d)}else{if(HandleManager.shape instanceof Container){this.actionContainer(e,f,d)}}}}},paint:function(c){c.save();c.beginPath();c.arc(this.x,this.y,Handle.RADIUS,0,Math.PI*2,false);c.fillStyle="rgb(0,255,0)";c.closePath();c.fill();c.beginPath();c.arc(this.x,this.y,Handle.RADIUS,0,Math.PI*2,false);c.strokeStyle="rgb(0,0,0)";c.closePath();c.stroke();if(this.type=="r"){var d=new Line(new Point(this.x,this.y),new Point(HandleManager.handles[1].x,HandleManager.handles[1].y));d.style.dashLength=3;d.style.strokeStyle="grey";d.paint(c)}c.restore()},contains:function(e,f){var d=new Point(this.x,this.y);return d.near(e,f,Handle.RADIUS)},getBounds:function(){return[this.x-Handle.RADIUS,this.y-Handle.RADIUS,this.x+Handle.RADIUS,this.y+Handle.RADIUS]},transform:function(d){var c=new Point(this.x,this.y);c.transform(d);this.x=c.x;this.y=c.y},getCursor:function(){if(HandleManager.shape instanceof Connector){if(this.visible==false){return""}if(this.type=="v"){return"ns-resize"}else{return"ew-resize"}}else{if(HandleManager.shape instanceof Figure){if(this.visible==false){return""}if(this.type=="r"){return"move"}var r=HandleManager.shape.getBounds();var q=new Point(r[0]+((r[2]-r[0])/2),(r[1]+((r[3]-r[1])/2)));var n=-1;var i=2*Math.PI;var l=-1;for(var m=0;m<HandleManager.handles.length-1;m++){var k=new Point(HandleManager.handles[m].x,HandleManager.handles[m].y);var p=Util.getAngle(q,k);if(p<=Math.PI){if(p<i){i=p;n=m}}else{if(2*Math.PI-p<i){i=2*Math.PI-p;n=m}}}for(var o=0;o<8;o++){if(HandleManager.handles[(n+o)%8]==this){return Handle.types[o]+"-resize"}}}else{if(HandleManager.shape instanceof Container){if(this.visible==false){return""}if(this.type=="r"){return"move"}var r=HandleManager.shape.getBounds();var q=new Point(r[0]+((r[2]-r[0])/2),(r[1]+((r[3]-r[1])/2)));var n=-1;var i=2*Math.PI;var l=-1;for(var m=0;m<HandleManager.handles.length-1;m++){var k=new Point(HandleManager.handles[m].x,HandleManager.handles[m].y);var p=Util.getAngle(q,k);if(p<=Math.PI){if(p<i){i=p;n=m}}else{if(2*Math.PI-p<i){i=2*Math.PI-p;n=m}}}for(var o=0;o<8;o++){if(HandleManager.handles[(n+o)%8]==this){return Handle.types[o]+"-resize"}}}}}return""}};function HandleManager(){}HandleManager.shape=null;HandleManager.handles=[];HandleManager.connectorHandles=[];HandleManager.selectRect=null;HandleManager.handleSelectedIndex=-1;HandleManager.handleOffset=0;HandleManager.handleGetSelected=function(){if(HandleManager.handleSelectedIndex!=-1){return HandleManager.handles[HandleManager.handleSelectedIndex]}return null};HandleManager.shapeSet=function(h){HandleManager.shape=h;HandleManager.handles=[];if(h instanceof Connector){HandleManager.selectRect=null;for(var g=1;g<h.turningPoints.length-2;g++){var l;if((!Util.collinearity(HandleManager.shape.turningPoints[g-1],HandleManager.shape.turningPoints[g],HandleManager.shape.turningPoints[g+1])&&(!Util.collinearity(HandleManager.shape.turningPoints[g],HandleManager.shape.turningPoints[g+1],HandleManager.shape.turningPoints[g+2])||HandleManager.shape.turningPoints[g+1].equals(HandleManager.shape.turningPoints[g+2])))||((!Util.collinearity(HandleManager.shape.turningPoints[g-1],HandleManager.shape.turningPoints[g],HandleManager.shape.turningPoints[g+1])||HandleManager.shape.turningPoints[g-1].equals(HandleManager.shape.turningPoints[g]))&&!Util.collinearity(HandleManager.shape.turningPoints[g],HandleManager.shape.turningPoints[g+1],HandleManager.shape.turningPoints[g+2]))){if(h.turningPoints[g].x==h.turningPoints[g+1].x){l=new Handle("h");l.x=HandleManager.shape.turningPoints[g].x;l.y=(HandleManager.shape.turningPoints[g].y+HandleManager.shape.turningPoints[g+1].y)/2}else{l=new Handle("v");l.x=(HandleManager.shape.turningPoints[g].x+HandleManager.shape.turningPoints[g+1].x)/2;l.y=HandleManager.shape.turningPoints[g].y}l.visible=true;HandleManager.handles.push(l)}}}else{if(h instanceof Figure||h instanceof Group){var i=Util.getAngle(HandleManager.shape.rotationCoords[0],HandleManager.shape.rotationCoords[1]);HandleManager.shape.transform(Matrix.rotationMatrix(-i),false);HandleManager.selectRect=new Polygon();var k=HandleManager.shape.getBounds();HandleManager.selectRect.points=[];HandleManager.selectRect.addPoint(new Point(k[0]-HandleManager.handleOffset,k[1]-HandleManager.handleOffset));HandleManager.selectRect.addPoint(new Point(k[2]+HandleManager.handleOffset,k[1]-HandleManager.handleOffset));HandleManager.selectRect.addPoint(new Point(k[2]+HandleManager.handleOffset,k[3]+HandleManager.handleOffset));HandleManager.selectRect.addPoint(new Point(k[0]-HandleManager.handleOffset,k[3]+HandleManager.handleOffset));k=HandleManager.selectRect.getBounds();var j=new Handle("nw");j.x=k[0];j.y=k[1];HandleManager.handles.push(j);j=new Handle("n");j.x=k[0]+(k[2]-k[0])/2;j.y=k[1];HandleManager.handles.push(j);j=new Handle("ne");j.x=k[2];j.y=k[1];HandleManager.handles.push(j);j=new Handle("e");j.x=k[2];j.y=k[1]+(k[3]-k[1])/2;HandleManager.handles.push(j);j=new Handle("se");j.x=k[2];j.y=k[3];HandleManager.handles.push(j);j=new Handle("s");j.x=k[0]+(k[2]-k[0])/2;j.y=k[3];HandleManager.handles.push(j);j=new Handle("sw");j.x=k[0];j.y=k[3];HandleManager.handles.push(j);j=new Handle("w");j.x=k[0];j.y=k[1]+(k[3]-k[1])/2;HandleManager.handles.push(j);j=new Handle("r");j.x=k[0]+(k[2]-k[0])/2;if(HandleManager.handleOffset!=0){j.y=k[1]-HandleManager.handleOffset*1.5}else{j.y=k[1]-15}HandleManager.handles.push(j);HandleManager.selectRect.transform(Matrix.rotationMatrix(i));HandleManager.shape.transform(Matrix.rotationMatrix(i),false);if(h instanceof Figure){if(h.primitives[0] instanceof Text&&h.primitives.length==1){for(var g=0;g<HandleManager.handles.length-1;g++){HandleManager.handles[g].visible=false}}}for(var g=0;g<HandleManager.handles.length;g++){HandleManager.handles[g].transform(Matrix.rotationMatrix(i))}}else{if(h instanceof Container){var k=HandleManager.shape.getBounds();HandleManager.selectRect=new Polygon();HandleManager.selectRect.points=[];HandleManager.selectRect.addPoint(new Point(k[0]-HandleManager.handleOffset,k[1]-HandleManager.handleOffset));HandleManager.selectRect.addPoint(new Point(k[2]+HandleManager.handleOffset,k[1]-HandleManager.handleOffset));HandleManager.selectRect.addPoint(new Point(k[2]+HandleManager.handleOffset,k[3]+HandleManager.handleOffset));HandleManager.selectRect.addPoint(new Point(k[0]-HandleManager.handleOffset,k[3]+HandleManager.handleOffset));k=HandleManager.selectRect.getBounds();var j=new Handle("nw");j.x=k[0];j.y=k[1];HandleManager.handles.push(j);j=new Handle("n");j.x=k[0]+(k[2]-k[0])/2;j.y=k[1];HandleManager.handles.push(j);j=new Handle("ne");j.x=k[2];j.y=k[1];HandleManager.handles.push(j);j=new Handle("e");j.x=k[2];j.y=k[1]+(k[3]-k[1])/2;HandleManager.handles.push(j);j=new Handle("se");j.x=k[2];j.y=k[3];HandleManager.handles.push(j);j=new Handle("s");j.x=k[0]+(k[2]-k[0])/2;j.y=k[3];HandleManager.handles.push(j);j=new Handle("sw");j.x=k[0];j.y=k[3];HandleManager.handles.push(j);j=new Handle("w");j.x=k[0];j.y=k[1]+(k[3]-k[1])/2;HandleManager.handles.push(j)}}}};HandleManager.handleGetAll=function(){return HandleManager.handles};HandleManager.handleGet=function(e,f){for(var d=0;d<HandleManager.handles.length;d++){if(HandleManager.handles[d].contains(e,f)){return HandleManager.handles[d]}}return null};HandleManager.handleSelectXY=function(e,f){HandleManager.handleSelectedIndex=-1;for(var d=0;d<HandleManager.handles.length;d++){if(HandleManager.handles[d].contains(e,f)){HandleManager.handleSelectedIndex=d}}};HandleManager.clear=function(){HandleManager.handleSelectedIndex=-1;HandleManager.shape=null;HandleManager.handles=[]};HandleManager.paint=function(f){var d=HandleManager.handleGetAll();f.save();if(HandleManager.selectRect!=null){HandleManager.selectRect.style.strokeStyle="grey";HandleManager.selectRect.paint(f)}for(var e=0;e<d.length;e++){if(d[e].visible==true){d[e].paint(f)}}f.restore()};