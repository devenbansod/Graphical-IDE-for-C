function Stack(){this.figures=[];this.groups=[];this.containers=[];this.currentId=0;this.idToIndex=[];this.oType="Stack"}Stack.load=function(c){var d=new Stack();d.figures=Figure.loadArray(c.figures);d.containers=Container.loadArray(c.containers);d.groups=Group.loadArray(c.groups);d.figureSelectedIndex=c.figureSelectedIndex;d.currentId=c.currentId;d.idToIndex=c.idToIndex;return d};Stack.prototype={constructor:Stack,groupCreate:function(i,f){for(var g=0;g<this.groups.length;g++){if(this.groups[g].permanent==false){throw"Stack::groupCreate()  You can not create new groups while you have temporary groups alive"}}var k=new Group(f);for(var g=0;g<i.length;g++){var j=this.figureGetById(i[g]);j.groupId=k.id}var l=k.getBounds();k.rotationCoords.push(new Point(l[0]+(l[2]-l[0])/2,l[1]+(l[3]-l[1])/2));k.rotationCoords.push(new Point(l[0]+(l[2]-l[0])/2,l[1]));this.groups.push(k);return k.id},groupGetById:function(c){for(var d=0;d<this.groups.length;d++){if(this.groups[d].id==c){return this.groups[d]}}return null},groupDestroy:function(h){var f=-1;for(var e=0;e<this.groups.length;e++){if(this.groups[e].id==h){f=e;break}}if(f>-1){this.groups.splice(f,1);var g=this.figureGetByGroupId(h);for(var e=0;e<g.length;e++){g[e].groupId=-1}}},groupRemoveTemporary:function(){throw Exception("Not implemented")},equals:function(d){var f="";if(!d instanceof Stack){return false;f+="not same class"}if(this.figures.length!=d.figures.length){f+="not same nr of figures";return false}for(var e=0;e<this.figures.length;e++){if(!this.figures[e].equals(d.figures[e])){f+="figures not the same";return false}}if(this.groups.length!=d.groups.length){f+="not same nr of groups";return false}for(var e=0;e<this.groups.length;e++){if(!this.groups[e].equals(d.groups[e])){f+="groups not the same";return false}}for(var e=0;e<this.figures.idToIndex;e++){if(this.idToIndex[e]!=undefined&&d.idToIndex!=undefined&&this.idToIndex[e]!=d.idToIndex[e]){f+="not same idToIndex";return false}}if(this.currentId!=d.currentId){f+="not same currentId";return false}if(f!=""){alert(f)}return true},generateId:function(){return this.currentId++},figureAdd:function(b){this.figures.push(b);this.idToIndex[b.id]=this.figures.length-1},containerAdd:function(b){this.containers.push(b)},figureRemove_deprecated:function(e){var d=-1;for(var f=0;f<this.figures.length;f++){if(this.figures[f]==e){d=f;break}}CONNECTOR_MANAGER.connectionPointRemoveAllByParent(e.id);if(d>-1){this.figures.splice(d,1);for(var f=d;f<this.figures.length;f++){this.idToIndex[this.figures[f].id]=f}}if(d<this.figureSelectedIndex&&d!=-1){this.figureSelectedIndex--}},containerRemoveById:function(e){var d=-1;for(var f=0;f<this.containers.length;f++){if(this.containers[f].id===e){d=f;break}}if(d>-1){this.containers.splice(d,1)}},figureRemoveById:function(i){var g=-1;for(var l=0;l<this.figures.length;l++){if(this.figures[l].id==i){g=l;break}}if(g>-1){var j=CONNECTOR_MANAGER.connectionPointGetAllByParent(i);var k=j.length;var h;for(h=0;h<k;h++){CONNECTOR_MANAGER.glueRemoveAllByFirstId(j[h].id)}CONNECTOR_MANAGER.connectionPointRemoveAllByParent(i);this.figures.splice(g,1);this.reindex()}},reindex:function(){for(var b=0;b<this.figures.length;b++){this.idToIndex[this.figures[b].id]=b}},reset:function(){this.figures=[];this.figureSelectedIndex=-1;this.currentId=0},getIndex:function(d){for(var c=0;c<this.figures.length;c++){if(this.figures[c]==d){return c}}return -1},figureGetByGroupId:function(d){var f=[];for(var e=0;e<this.figures.length;e++){if(this.figures[e].groupId==d){f.push(this.figures[e])}}return f},figureGetIdsByGroupId:function(d){var f=[];for(var e=0;e<this.figures.length;e++){if(this.figures[e].groupId==d){f.push(this.figures[e].id)}}return f},figureGetById:function(c){for(var d=0;d<this.figures.length;d++){if(this.figures[d].id==c){return this.figures[d]}}return null},figureGetAsFirstFigureForConnector:function(f){Log.group("STACK: figureGetAsFirstFigureForConnector");var g=null;Log.debug("Connector id = "+f);var i=CONNECTOR_MANAGER.connectionPointGetFirstForConnector(f);Log.debug("ConnectionPoint id = "+i.id);var j=CONNECTOR_MANAGER.glueGetBySecondConnectionPointId(i.id)[0];if(j){Log.debug("Glue id1 = ("+j.id1+", "+j.id2+")");var h=CONNECTOR_MANAGER.connectionPointGetById(j.id1);Log.debug("Figure's ConnectionPoint id = "+h.id);g=this.figureGetById(h.parentId)}else{Log.debug("no glue")}Log.groupEnd();return g},figureGetAsSecondFigureForConnector:function(j){Log.group("STACK: figureGetAsSecondFigureForConnector");var g=null;Log.debug("Connector id = "+j);var f=CONNECTOR_MANAGER.connectionPointGetSecondForConnector(j);Log.debug("ConnectionPoint id = "+f.id);var i=CONNECTOR_MANAGER.glueGetBySecondConnectionPointId(f.id)[0];if(i){Log.debug("Glue id1 = ("+i.id1+", "+i.id2+")");var h=CONNECTOR_MANAGER.connectionPointGetById(i.id1);Log.debug("Figure's ConnectionPoint id = "+h.id);g=this.figureGetById(h.parentId)}else{Log.debug("no glue")}Log.groupEnd();return g},figureGetByXY:function(f,g){var h=-1;for(var e=this.figures.length-1;e>=0;e--){if(this.figures[e].contains(f,g)){h=this.figures[e].id;break}}return h},textGetByFigureXY:function(o,i,j){var r=this.figures.length;for(var p=r-1;p>=0;p--){var l=this.figures[p];if(l.id===o){var m=l.primitives.length;for(var q=m-1;q>=0;q--){var n=l.primitives[q];if((n.oType=="Text")&&n.contains(i,j)){return n.id}}}}return -1},textGetByContainerXY:function(j,i,l){var q=this.containers.length;for(var o=q-1;o>=0;o--){var r=this.containers[o];if(r.id===j){var m=r.primitives.length;for(var p=m-1;p>=0;p--){var n=r.primitives[p];if((n.oType=="Text")&&n.contains(i,l)){return n.id}}}}return -1},containerGetByXY:function(f,g){var h=-1;for(var e=this.containers.length-1;e>=0;e--){if(this.containers[e].contains(f,g)){h=this.containers[e].id;break}}return h},containerGetByXYOnEdge:function(f,g){var h=-1;for(var e=this.containers.length-1;e>=0;e--){if(this.containers[e].onEdge(f,g)){h=this.containers[e].id;break}}return h},containerGetById:function(c){for(var d=0;d<this.containers.length;d++){if(this.containers[d].id==c){return this.containers[d]}}return null},figuresGetByXY:function(f,g){var h=[];for(var e=this.figures.length-1;e>=0;e--){if(this.figures[e].contains(f,g)){h.push(this.figures[e].id)}}return h},setPosition_deprecated:function(g,h){var k=-1;for(var j=0;j<this.figures.length;j++){if(this.figures[j]==g){k=j}}if(k!=-1&&h>=0&&h<this.figures.length){var l=this.figures.splice(k,1);this.figures.splice(h,0,l[0]);var i=false;for(var j=0;j<this.figures.length;j++){this.idToIndex[this.figures[j].id]=j}this.figureSelectedIndex=h}},swapToPosition:function(h,e){var g=this.idToIndex[h];if(g!=-1&&e>=0&&e<this.figures.length){this.idToIndex[h]=e;this.idToIndex[this.figures[e].id]=g;var f=this.figures[g];this.figures[g]=this.figures[e];this.figures[e]=f}},setPosition:function(k,l){var j=this.idToIndex[k];var h=this.figures[j];var i=-1;if(j<l){i=1}Log.info(i);for(var g=j;g!=l;g+=i){this.figures[g]=this.figures[g+i];this.idToIndex[this.figures[g].id]=g}this.figures[l]=h;this.idToIndex[this.figures[l].id]=l},figureIsOver:function(f,h){var i=false;for(var j=0;j<this.figures.length;j++){var g=this.figures[j];if(g.contains(f,h)){i=true;break}}return i},containerIsOver:function(g,h){var i=false;for(var j=0;j<this.containers.length;j++){var f=this.containers[j];if(f.contains(g,h)){i=true;break}}return i},containerIsOnEdge:function(g,h){var i=false;for(var j=0;j<this.containers.length;j++){var f=this.containers[j];if(f.onEdge(g,h)){i=true;break}}return i},paint:function(B,z){if(DIAGRAMO.debug){var c=1;B.save();B.font="10px Arial";B.fillStyle="#000000";B.strokeStyle="#000000";B.lineWidth=1;B.fillText("state: "+state,0,10*c++);B.fillText("selectedFigureId: : "+selectedFigureId,0,10*c++);B.fillText("selectedGroupId: : "+selectedGroupId,0,10*c++);B.fillText("selectedContainerId: : "+selectedContainerId,0,10*c++);if(selectedGroupId!=-1){var E=this.groupGetById(selectedGroupId);B.fillText("permanent: : "+E.permanent,0,10*c++)}B.fillText("selectedConnectorId: : "+selectedConnectorId,0,10*c++);if(selectedConnectorId!=-1){var y=CONNECTOR_MANAGER.connectorGetById(selectedConnectorId);B.fillText("connector type: : "+y.type,0,10*c++)}B.restore()}for(var w=0;w<this.containers.length;w++){B.save();this.containers[w].paint(B);B.restore()}for(var w=0;w<this.figures.length;w++){if(!B.save){alert("save() no present")}B.save();this.figures[w].paint(B);B.restore();if(state==STATE_CONNECTOR_PICK_FIRST||state==STATE_CONNECTOR_PICK_SECOND||state==STATE_CONNECTOR_MOVE_POINT){CONNECTOR_MANAGER.connectionPointPaint(B,this.figures[w].id)}}if(state==STATE_CONNECTOR_PICK_FIRST||state==STATE_CONNECTOR_PICK_SECOND||state==STATE_CONNECTOR_MOVE_POINT){CONNECTOR_MANAGER.connectionCloudPaint(B)}CONNECTOR_MANAGER.connectorPaint(B,selectedConnectorId);if(state==STATE_FIGURE_SELECTED){var j=this.figureGetById(selectedFigureId);HandleManager.shapeSet(j);if(!z){HandleManager.paint(B)}}else{if(state==STATE_CONNECTOR_SELECTED){var f=CONNECTOR_MANAGER.connectorGetById(selectedConnectorId);HandleManager.shapeSet(f);if(!z){HandleManager.paint(B)}}else{if(state==STATE_CONTAINER_SELECTED){var D=STACK.containerGetById(selectedContainerId);HandleManager.shapeSet(D);if(!z){HandleManager.paint(B)}}else{if(state==STATE_GROUP_SELECTED){var v=this.groupGetById(selectedGroupId);HandleManager.shapeSet(v);if(!z){HandleManager.paint(B)}}else{if(state==STATE_SELECTING_MULTIPLE){if(SHIFT_PRESSED){if(selectedFigureId!=-1){var j=this.figureGetById(selectedFigureId);HandleManager.paint(B)}if(selectedGroupId!=-1){var v=this.groupGetById(selectedGroupId);HandleManager.paint(B)}}selectionArea.paint(B);Log.info(selectionArea.toString())}}}}}if(DIAGRAMO.debug){var C={s0:"#ff0000",s1_1:"#009900",s1_2:"#0033ff",s2_1:"#00ff33",s2_2:"#ff3399",s2_3:"#808019",s2_4:"#e6e64c",s2_5:"#e67814",s2_6:"#309bda"};B.save();for(var w=0;w<DIAGRAMO.debugSolutions.length;w++){var A=3+w*3;var g=DIAGRAMO.debugSolutions[w];var F=g[2];B.save();B.strokeStyle=C[g[1]];B.lineWidth=1;B.beginPath();B.moveTo(F[0].x+A,F[0].y+A);for(var x=1;x<F.length;x++){B.lineTo(F[x].x+A,F[x].y+A)}B.stroke();B.restore();for(var x=0;x<F.length;x++){B.save();B.beginPath();B.strokeStyle="#cccccc";B.arc(F[x].x,F[x].y,3,0,Math.PI*2,true);B.stroke();B.restore()}}c+=4;for(var i in C){B.save();B.strokeText(i,0,10*c);B.strokeStyle=C[i];B.beginPath();B.moveTo(50,10*c);B.lineTo(150,10*c);B.stroke();B.restore();c+=2}B.restore()}},toSVG:function(){var d="";for(var c=0;c<this.figures.length;c++){d+=this.figures[c].toSVG()}return d}};